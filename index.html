<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enciclop√©dia Imperial: Receitas do Mundo</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ü•ò</text></svg>">
    
    <!-- Bibliotecas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.lordicon.com/lordicon.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'imperial-red': '#8B0000',
                        'imperial-gold': '#DAA520',
                        'cream': '#FDFBF7',
                        'stone-dark': '#292524'
                    },
                    fontFamily: {
                        serif: ['Playfair Display', 'serif'],
                        sans: ['Lato', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Lato:wght@300;400;700&display=swap');

        body { font-family: 'Lato', sans-serif; background-color: #f8f9fa; color: #292524; }
        .serif-font { font-family: 'Playfair Display', serif; }

        .card-hover { transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); }
        .card-hover:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0,0,0,0.1); }

        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #d6d3d1; border-radius: 3px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #a8a29e; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        
        .img-loading {
            background-color: #e2e8f0;
            background-image: url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23cbd5e0' fill-rule='evenodd'%3E%3Cpath d='M0 40L40 0H20L0 20M40 40V20L20 40'/%3E%3C/g%3E%3C/svg%3E");
        }

        video:fullscreen { object-fit: contain; }

        /* Estilo para abas do admin */
        .admin-tab.active { border-bottom: 2px solid #8B0000; color: #8B0000; background: white; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-white sticky top-0 z-40 border-b border-gray-200 shadow-sm">
        <div class="container mx-auto px-4 pt-3 pb-2">
            <div class="flex flex-col md:flex-row justify-between items-center mb-3">
                
                <!-- Logo -->
                <div class="flex items-center space-x-3 mb-3 md:mb-0 cursor-pointer group" onclick="window.resetApp()">
                    <div class="w-12 h-12 rounded-full bg-imperial-red text-white flex items-center justify-center font-bold text-2xl shadow-lg group-hover:bg-red-800 transition ring-2 ring-offset-2 ring-imperial-gold">
                        È£ü
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold tracking-tight text-gray-900 serif-font">Enciclop√©dia Imperial</h1>
                        <p class="text-xs text-gray-500 font-bold uppercase tracking-wider">Gastronomia Global</p>
                    </div>
                </div>
                
                <!-- Ferramentas -->
                <div class="flex w-full md:w-auto items-center space-x-3">
                    <div class="relative flex-grow md:w-80">
                        <input type="text" id="searchInput" placeholder="O que voc√™ quer cozinhar hoje?" 
                            class="w-full pl-10 pr-4 py-2 rounded-full bg-gray-100 border-none focus:ring-2 focus:ring-imperial-red focus:bg-white transition text-sm">
                        <i class="fas fa-search absolute left-3.5 top-3 text-gray-400"></i>
                    </div>

                    <!-- Auth -->
                    <div id="authContainer">
                        <button id="loginBtn" onclick="handleLogin()" class="hidden bg-imperial-red text-white hover:bg-red-800 font-bold py-2 px-4 rounded-full text-sm shadow transition">
                            <i class="fab fa-google mr-2"></i> Entrar
                        </button>
                        <div id="loginLoading" class="text-xs text-gray-400 animate-pulse">Conectando...</div>
                        
                        <div id="userProfile" class="hidden relative group cursor-pointer">
                            <img id="userPhoto" src="" class="w-10 h-10 rounded-full border-2 border-white shadow-md object-cover ring-2 ring-gray-100">
                            <!-- Menu Usuario (Ponte Invisivel) -->
                            <div class="absolute right-0 top-full pt-2 w-48 hidden group-hover:block z-50">
                                <div class="bg-white rounded-xl shadow-xl py-2 border border-gray-100 animate-fade-in">
                                    <div class="px-4 py-2 border-b border-gray-100">
                                        <p class="text-xs text-gray-500">Bem-vindo,</p>
                                        <p class="text-sm font-bold truncate" id="userName">Visitante</p>
                                    </div>
                                    <a href="#" onclick="showSavedRecipes()" class="block px-4 py-2 text-sm hover:bg-red-50 text-imperial-red font-bold">
                                        <i class="fas fa-heart mr-2"></i> Favoritos (<span id="savedCountDropdown">0</span>)
                                    </a>
                                    <a href="#" onclick="handleLogout()" class="block px-4 py-2 text-sm hover:bg-gray-50 text-gray-700">Sair</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Navega√ß√£o Categorias -->
            <div class="w-full pt-1 border-t border-gray-100">
                <div class="overflow-x-auto scrollbar-hide flex justify-start md:justify-center px-1 pb-1">
                    <div class="flex space-x-2 min-w-max py-2" id="navCategories">
                        <!-- Injetado via JS -->
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Conte√∫do Principal -->
    <main class="container mx-auto px-4 py-8 flex-grow">
        <div class="flex justify-between items-end mb-8 border-b border-gray-200 pb-4">
            <div>
                <h2 class="text-3xl font-bold text-stone-900 serif-font" id="currentCatTitle">Cat√°logo Completo</h2>
                <p class="text-sm text-gray-500 mt-1 flex items-center">
                    <span id="dbStatus" class="inline-block w-2 h-2 rounded-full bg-green-500 mr-2"></span>
                    Sincronizado na Nuvem
                </p>
            </div>
            <span class="text-xs font-semibold bg-cream text-stone-600 px-3 py-1 rounded-full border border-stone-200" id="totalCount">Carregando...</span>
        </div>

        <div id="recipeGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8"></div>

        <div id="loadMoreContainer" class="text-center py-12 hidden">
            <button onclick="loadMore()" class="bg-white border border-stone-300 text-stone-600 hover:text-imperial-red hover:border-imperial-red font-bold py-3 px-10 rounded-full shadow-sm transition hover:shadow-md">Carregar Mais Receitas</button>
        </div>
        
        <div id="emptyState" class="hidden text-center py-24">
            <i class="fas fa-search text-4xl text-gray-300 mb-2"></i>
            <p class="text-gray-500 font-serif italic">Nenhuma receita encontrada para sua busca.</p>
        </div>
    </main>

    <!-- Footer Profissional -->
    <footer class="bg-stone-900 text-stone-400 pt-16 pb-8 mt-12 border-t border-stone-800">
        <div class="container mx-auto px-4">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-12 mb-12">
                <!-- Sobre -->
                <div class="col-span-1 md:col-span-1">
                    <div class="flex items-center space-x-3 mb-6">
                        <div class="w-10 h-10 rounded-full bg-imperial-red text-white flex items-center justify-center font-bold text-xl ring-2 ring-imperial-gold ring-offset-2 ring-offset-stone-900">È£ü</div>
                        <h3 class="text-xl font-bold text-stone-100 serif-font">Enciclop√©dia Imperial</h3>
                    </div>
                    <p class="text-sm text-stone-400 mb-6 leading-relaxed">
                        Sua fonte definitiva de receitas globais. Da culin√°ria chinesa milenar aos cl√°ssicos brasileiros, explorando sabores e tradi√ß√µes.
                    </p>
                    <div class="flex space-x-4">
                        <a href="#" class="text-stone-500 hover:text-white transition transform hover:scale-110"><i class="fab fa-instagram text-xl"></i></a>
                        <a href="#" class="text-stone-500 hover:text-white transition transform hover:scale-110"><i class="fab fa-facebook text-xl"></i></a>
                        <a href="#" class="text-stone-500 hover:text-white transition transform hover:scale-110"><i class="fab fa-youtube text-xl"></i></a>
                        <a href="#" class="text-stone-500 hover:text-white transition transform hover:scale-110"><i class="fab fa-pinterest text-xl"></i></a>
                    </div>
                </div>

                <!-- Categorias -->
                <div>
                    <h4 class="text-white font-bold mb-6 uppercase text-xs tracking-widest border-b border-stone-800 pb-2 inline-block">Explorar</h4>
                    <ul class="space-y-3 text-sm">
                        <li><a href="#" onclick="window.setCategory('brasileira')" class="hover:text-imperial-gold transition flex items-center"><i class="fas fa-chevron-right text-[10px] mr-2 opacity-50"></i> Receitas Brasileiras</a></li>
                        <li><a href="#" onclick="window.setCategory('chinesa')" class="hover:text-imperial-gold transition flex items-center"><i class="fas fa-chevron-right text-[10px] mr-2 opacity-50"></i> Receitas Chinesas</a></li>
                        <li><a href="#" onclick="window.setCategory('sobremesa')" class="hover:text-imperial-gold transition flex items-center"><i class="fas fa-chevron-right text-[10px] mr-2 opacity-50"></i> Doces & Sobremesas</a></li>
                        <li><a href="#" onclick="window.setCategory('medicinal')" class="hover:text-imperial-gold transition flex items-center"><i class="fas fa-chevron-right text-[10px] mr-2 opacity-50"></i> Sa√∫de & Bem-estar</a></li>
                    </ul>
                </div>

                <!-- Links √öteis -->
                <div>
                    <h4 class="text-white font-bold mb-6 uppercase text-xs tracking-widest border-b border-stone-800 pb-2 inline-block">Institucional</h4>
                    <ul class="space-y-3 text-sm">
                        <li><a href="#" class="hover:text-white transition">Sobre N√≥s</a></li>
                        <li><a href="#" class="hover:text-white transition">Pol√≠tica de Privacidade</a></li>
                        <li><a href="#" class="hover:text-white transition">Termos de Uso</a></li>
                        <li><a href="#" onclick="toggleAdminPanel()" class="text-stone-600 hover:text-imperial-red transition text-xs"><i class="fas fa-lock mr-1"></i> √Årea Administrativa</a></li>
                    </ul>
                </div>

                <!-- Contato -->
                <div>
                    <h4 class="text-white font-bold mb-6 uppercase text-xs tracking-widest border-b border-stone-800 pb-2 inline-block">Contato</h4>
                    <ul class="space-y-3 text-sm">
                        <li class="flex items-start"><i class="fas fa-map-marker-alt mt-1 mr-3 text-imperial-red"></i> <span class="text-stone-400">Av. das Na√ß√µes, 1000<br>S√£o Paulo, SP</span></li>
                        <li class="flex items-center"><i class="fas fa-envelope mr-3 text-imperial-red"></i> <a href="mailto:contato@imperial.com" class="hover:text-white transition">contato@imperial.com</a></li>
                    </ul>
                </div>
            </div>
            
            <div class="border-t border-stone-800 pt-8 flex flex-col md:flex-row justify-between items-center text-xs text-stone-600">
                <p>&copy; 2024 Enciclop√©dia Imperial. Todos os direitos reservados.</p>
                <p class="mt-2 md:mt-0">Feito com <i class="fas fa-heart text-imperial-red mx-1"></i> para o mundo.</p>
            </div>
        </div>
    </footer>

    <!-- PAINEL ADMINISTRATIVO (Modal) -->
    <div id="adminModal" class="fixed inset-0 bg-black bg-opacity-90 z-[70] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl w-full max-w-5xl h-[90vh] flex flex-col shadow-2xl overflow-hidden animate-fade-in">
            <!-- Admin Header -->
            <div class="bg-gray-900 text-white p-4 flex justify-between items-center shrink-0">
                <h2 class="text-xl font-bold flex items-center"><i class="fas fa-database mr-3 text-red-500"></i> Gest√£o de Receitas</h2>
                <button onclick="toggleAdminPanel()" class="text-gray-400 hover:text-white"><i class="fas fa-times text-2xl"></i></button>
            </div>

            <!-- Admin Tabs -->
            <div class="flex border-b border-gray-200 bg-gray-50 shrink-0">
                <button onclick="switchAdminTab('add')" id="btn-tab-add" class="admin-tab active flex-1 py-4 text-sm font-bold text-gray-600 hover:bg-white focus:outline-none">
                    <i class="fas fa-plus-circle mr-2"></i> Adicionar
                </button>
                <button onclick="switchAdminTab('magic')" id="btn-tab-magic" class="admin-tab flex-1 py-4 text-sm font-bold text-gray-600 hover:bg-white focus:outline-none">
                    <i class="fas fa-magic mr-2"></i> Gerador M√°gico
                </button>
                <button onclick="switchAdminTab('bulk')" id="btn-tab-bulk" class="admin-tab flex-1 py-4 text-sm font-bold text-gray-600 hover:bg-white focus:outline-none">
                    <i class="fas fa-file-import mr-2"></i> Importar JSON
                </button>
                <button onclick="switchAdminTab('backup')" id="btn-tab-backup" class="admin-tab flex-1 py-4 text-sm font-bold text-gray-600 hover:bg-white focus:outline-none">
                    <i class="fas fa-sync mr-2"></i> Backup & Sync
                </button>
            </div>

            <!-- Admin Content -->
            <div class="p-6 overflow-y-auto bg-gray-50 flex-grow">
                
                <!-- TAB: Adicionar Manual -->
                <div id="tab-add" class="admin-content space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" id="addName" placeholder="Nome da Receita (ex: Feijoada Suprema)" class="p-3 border rounded w-full focus:ring-2 focus:ring-red-500">
                        <select id="addCategory" class="p-3 border rounded w-full bg-white">
                            <!-- Preenchido via JS -->
                        </select>
                    </div>
                    <input type="text" id="addImage" placeholder="URL da Imagem (https://...)" class="p-3 border rounded w-full">
                    <textarea id="addDesc" placeholder="Descri√ß√£o curta e apetitosa..." class="p-3 border rounded w-full h-20"></textarea>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="space-y-1">
                            <label class="text-xs font-bold text-gray-500">INGREDIENTES (um por linha)</label>
                            <textarea id="addIng" class="p-3 border rounded w-full h-40 font-mono text-sm" placeholder="- 500g de Feij√£o&#10;- 2 Cebolas"></textarea>
                        </div>
                        <div class="space-y-1">
                            <label class="text-xs font-bold text-gray-500">MODO DE PREPARO (um por linha)</label>
                            <textarea id="addSteps" class="p-3 border rounded w-full h-40 font-mono text-sm" placeholder="1. Cozinhe o feij√£o&#10;2. Refogue a cebola"></textarea>
                        </div>
                    </div>
                    <button onclick="saveRecipe()" class="w-full bg-green-600 text-white py-4 rounded font-bold hover:bg-green-700 shadow-lg transform active:scale-95 transition">
                        <i class="fas fa-save mr-2"></i> Salvar na Nuvem
                    </button>
                </div>

                <!-- TAB: Gerador M√°gico -->
                <div id="tab-magic" class="admin-content hidden space-y-4">
                    <div class="bg-blue-50 p-6 rounded-lg border border-blue-200">
                        <h3 class="font-bold text-blue-900 mb-2">Cole qualquer texto de receita aqui!</h3>
                        <p class="text-sm text-blue-700 mb-4">O sistema tentar√° identificar automaticamente o t√≠tulo, ingredientes e passos.</p>
                        <textarea id="magicPaste" class="w-full h-64 p-4 border rounded shadow-inner" placeholder="Cole o texto da receita aqui..."></textarea>
                        <button onclick="parseMagicText()" class="mt-4 bg-blue-600 text-white px-6 py-2 rounded font-bold hover:bg-blue-700 shadow">
                            <i class="fas fa-wand-magic-sparkles mr-2"></i> Processar Texto
                        </button>
                    </div>
                </div>

                <!-- TAB: Importa√ß√£o em Massa -->
                <div id="tab-bulk" class="admin-content hidden space-y-4">
                    <div class="bg-purple-50 p-6 rounded-lg border border-purple-200">
                        <h3 class="font-bold text-purple-900 mb-2">Importar JSON</h3>
                        <p class="text-sm text-purple-700 mb-4">Cole um array de objetos JSON para adicionar v√°rias receitas de uma vez.</p>
                        <textarea id="bulkJson" class="w-full h-64 p-4 border rounded font-mono text-xs bg-gray-900 text-green-400" placeholder='[{"name": "Bolo", "category": "bolo", ...}]'></textarea>
                        <button onclick="importBulk()" class="mt-4 bg-purple-600 text-white px-6 py-2 rounded font-bold hover:bg-purple-700 shadow">
                            <i class="fas fa-file-import mr-2"></i> Importar Dados
                        </button>
                    </div>
                </div>

                <!-- TAB: Backup & Sync -->
                <div id="tab-backup" class="admin-content hidden text-center pt-10">
                    <div class="max-w-md mx-auto bg-white p-8 rounded-xl shadow-lg border border-gray-200">
                        <i class="fas fa-cloud-upload-alt text-6xl text-gray-300 mb-4"></i>
                        <h3 class="text-2xl font-bold text-gray-800 mb-2">Gest√£o de Dados</h3>
                        <p class="text-gray-500 mb-6">Total de Receitas Locais + Nuvem: <span id="adminTotalCount" class="font-bold text-gray-900">0</span></p>
                        
                        <div class="space-y-3">
                            <button onclick="downloadBackup()" class="w-full bg-gray-800 text-white py-3 rounded hover:bg-black transition">
                                <i class="fas fa-download mr-2"></i> Baixar Backup Completo (.json)
                            </button>
                            <label class="block w-full bg-gray-100 text-gray-700 py-3 rounded hover:bg-gray-200 cursor-pointer border border-gray-300 transition">
                                <i class="fas fa-upload mr-2"></i> Restaurar Backup
                                <input type="file" class="hidden" onchange="restoreBackup(this)">
                            </label>
                            <button onclick="syncGeneratedToFirebase()" class="w-full bg-orange-600 text-white py-3 rounded hover:bg-orange-700 transition">
                                <i class="fas fa-sync mr-2"></i> Sincronizar Tudo
                            </button>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Modal Receita -->
    <div id="recipeModal" class="fixed inset-0 bg-stone-900 bg-opacity-95 z-50 hidden flex items-center justify-center p-0 md:p-4 backdrop-blur-md transition-opacity">
        <div class="bg-cream rounded-none md:rounded-3xl w-full max-w-6xl h-full md:h-[95vh] flex flex-col shadow-2xl overflow-hidden animate-fade-in relative border border-stone-200">
            
            <!-- Header Modal Imagem -->
            <div class="relative h-56 md:h-64 shrink-0 bg-stone-100 group cursor-zoom-in" onclick="window.toggleZoom()">
                <img id="modalImage" src="" class="w-full h-full object-cover" onerror="this.style.display='none'; document.getElementById('modalFallback').classList.remove('hidden')">
                
                <!-- Fallback Animado -->
                <div id="modalFallback" class="hidden absolute inset-0 flex flex-col items-center justify-center bg-stone-50">
                    <lord-icon id="modalLordIcon" src="" trigger="loop" delay="1000" colors="primary:#8B0000,secondary:#DAA520" style="width:100px;height:100px"></lord-icon>
                </div>

                <div class="absolute inset-0 bg-gradient-to-t from-stone-900 via-stone-900/40 to-transparent"></div>
                <button onclick="event.stopPropagation(); window.closeModal()" class="absolute top-4 right-4 bg-black/40 hover:bg-black/80 text-white w-10 h-10 rounded-full flex items-center justify-center transition backdrop-blur-md z-20"><i class="fas fa-times text-lg"></i></button>

                <div class="absolute bottom-0 left-0 w-full p-8 text-white z-10 pointer-events-none">
                    <div class="flex items-center space-x-3 mb-2">
                        <span id="modalCategoryTag" class="px-3 py-1 bg-white/20 backdrop-blur-sm text-white text-xs font-bold uppercase tracking-wider rounded border border-white/30">Cat</span>
                        <div class="flex text-imperial-gold text-sm" id="modalRating"></div>
                    </div>
                    <h2 id="modalTitle" class="text-3xl md:text-5xl font-bold serif-font leading-tight drop-shadow-xl text-shadow">T√≠tulo</h2>
                </div>
            </div>

            <!-- Toolbar -->
            <div class="bg-white border-b border-stone-200 px-8 py-4 flex justify-between items-center shrink-0">
                <div class="flex space-x-6 text-sm font-bold text-stone-600">
                    <span class="flex items-center"><i class="far fa-clock text-imperial-red mr-2"></i> <span id="modalTime"></span></span>
                    <span class="hidden md:flex items-center"><i class="fas fa-fire text-orange-500 mr-2"></i> <span id="modalFunction"></span></span>
                </div>
                <div class="flex space-x-3">
                    <button id="ttsBtn" onclick="window.toggleTTS()" class="flex items-center space-x-2 px-4 py-2 rounded-full bg-stone-100 hover:bg-stone-200 text-stone-700 transition text-sm font-bold" title="Ouvir">
                        <i class="fas fa-volume-up"></i> <span class="hidden md:inline">Ouvir</span>
                    </button>
                    <button onclick="window.toggleZoom()" class="flex items-center space-x-2 px-4 py-2 rounded-full bg-stone-100 hover:bg-stone-200 text-stone-700 transition text-sm font-bold" title="Zoom">
                        <i class="fas fa-search-plus"></i>
                    </button>
                    <button onclick="window.shareRecipeFromModal()" class="flex items-center space-x-2 px-4 py-2 rounded-full bg-blue-50 hover:bg-blue-100 text-blue-600 transition text-sm font-bold" title="Compartilhar">
                        <i class="fas fa-share-alt"></i>
                    </button>
                    <button onclick="window.toggleSaveRecipe(window.currentModalRecipeId)" id="modalSaveBtn" class="flex items-center space-x-2 px-4 py-2 rounded-full bg-stone-100 hover:bg-pink-50 text-stone-600 hover:text-pink-600 transition text-sm font-bold" title="Salvar">
                        <i class="far fa-heart"></i>
                    </button>
                </div>
            </div>

            <!-- Conte√∫do (Layout Sofisticado) -->
            <div class="flex flex-col md:flex-row overflow-hidden flex-grow bg-cream" id="modalScrollContainer">
                
                <!-- Coluna Esquerda: V√≠deo e Ingredientes -->
                <div class="md:w-1/3 bg-white p-8 border-r border-stone-100 overflow-y-auto custom-scroll" id="modalLeftCol">
                    <!-- V√≠deo Embutido -->
                    <div class="mb-8 rounded-xl overflow-hidden shadow-lg border border-stone-200 bg-black relative group">
                        <video id="modalVideo" controls class="w-full aspect-video" poster="">
                            <source src="https://videos.pexels.com/video-files/2882090/2882090-hd_1920_1080_24fps.mp4" type="video/mp4">
                        </video>
                    </div>
                    
                    <h3 class="font-serif font-bold text-imperial-red text-2xl mb-4 border-b border-stone-200 pb-2">
                        Ingredientes
                    </h3>
                    <ul id="modalIngredients" class="space-y-3 text-sm text-stone-700"></ul>
                </div>

                <!-- Coluna Direita: Modo de Preparo -->
                <div class="md:w-2/3 p-8 overflow-y-auto custom-scroll" id="modalRightCol">
                    <h3 class="font-serif font-bold text-imperial-red text-2xl mb-4 border-b border-stone-200 pb-2">
                        Modo de Preparo
                    </h3>
                    <p id="modalDesc" class="text-stone-600 italic mb-8 text-base leading-relaxed bg-stone-50 p-5 rounded-r-xl border-l-4 border-imperial-gold shadow-sm"></p>
                    <div id="modalSteps" class="space-y-6 text-stone-800 leading-relaxed text-lg font-light"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Zoom Lightbox -->
    <div id="zoomModal" class="fixed inset-0 bg-black bg-opacity-95 z-[70] hidden flex items-center justify-center p-4" onclick="window.toggleZoom()">
        <img id="zoomedImage" src="" class="max-w-full max-h-full object-contain rounded shadow-2xl">
        <button class="absolute top-5 right-5 text-white text-4xl hover:text-gray-300">&times;</button>
    </div>

    <!-- SCRIPT PRINCIPAL (L√≥gica UI, Dados, Admin) -->
    <script>
        // ESTADO GLOBAL
        window.generatedRecipes = [];
        window.finalRecipeList = [];
        window.firebaseRecipes = [];
        window.savedRecipesSet = new Set();
        window.isOffline = false;
        window.currentModalRecipeId = null;
        window.currentCategory = 'all';

        // Configura√ß√£o de Categorias e √çcones Animados (Lordicon URLs)
        const categories = {
            'brasileira': { label: 'üáßüá∑ Brasil', icon: 'https://cdn.lordicon.com/qhgmphtg.json', flavor: 'Tradicional' }, 
            'chinesa': { label: 'üá®üá≥ China', icon: 'https://cdn.lordicon.com/ulnswmkk.json', flavor: 'Umami' },
            'natal': { label: 'üéÑ Natal', icon: 'https://cdn.lordicon.com/fihkmkwt.json', flavor: 'Festivo' },
            'suco': { label: 'üçπ Sucos', icon: 'https://cdn.lordicon.com/pbrgppbb.json', flavor: 'Refrescante' },
            'sopa': { label: 'ü•£ Sopas', icon: 'https://cdn.lordicon.com/gqzfzudq.json', flavor: 'Reconfortante' },
            'bolo': { label: 'üç∞ Bolos', icon: 'https://cdn.lordicon.com/ivhjpjsw.json', flavor: 'Doce' },
            'carne': { label: 'ü•© Carnes', icon: 'https://cdn.lordicon.com/xryjrepg.json', flavor: 'Salgado' },
            'ave': { label: 'üçó Aves', icon: 'https://cdn.lordicon.com/hifghsbr.json', flavor: 'Assado' },
            'peixe': { label: 'üêü Peixes', icon: 'https://cdn.lordicon.com/drtetngs.json', flavor: 'Leve' },
            'massa': { label: 'üçù Massas', icon: 'https://cdn.lordicon.com/tqvgdoln.json', flavor: 'Italiano' },
            'salada': { label: 'ü•ó Saladas', icon: 'https://cdn.lordicon.com/sbiheqdr.json', flavor: 'Saud√°vel' },
            'sobremesa': { label: 'üçÆ Doces', icon: 'https://cdn.lordicon.com/yxyampds.json', flavor: 'Sobremesa' },
            'medicinal': { label: 'üíä Sa√∫de', icon: 'https://cdn.lordicon.com/puvaffet.json', flavor: 'Nutritivo' },
            'bebida': { label: 'üçµ Bebidas', icon: 'https://cdn.lordicon.com/pbrgppbb.json', flavor: 'Quente/Frio' },
            'entrada': { label: 'ü•ü Entradas', icon: 'https://cdn.lordicon.com/gqzfzudq.json', flavor: 'Aperitivo' },
            'principal': { label: 'ü•ò Pratos', icon: 'https://cdn.lordicon.com/xryjrepg.json', flavor: 'Completo' }
        };

        // Renderiza Menu
        const menuContainer = document.getElementById('navCategories');
        const menuKeys = ['all', 'brasileira', 'chinesa', 'natal', 'bolo', 'carne', 'massa', 'sobremesa', 'suco', 'sopa', 'ave', 'peixe', 'salada', 'medicinal', 'saved'];
        
        menuKeys.forEach(key => {
            const btn = document.createElement('button');
            const info = categories[key] || { label: key === 'all' ? 'Todos' : (key === 'saved' ? '‚ù§Ô∏è Favoritos' : key) };
            
            btn.className = `cat-btn px-5 py-2 rounded-full text-xs font-bold transition border border-stone-200 bg-white text-stone-600 hover:bg-stone-50 mr-3 mb-1 whitespace-nowrap shadow-sm hover:shadow`;
            if (key === 'all') btn.classList.add('bg-stone-800', 'text-white', 'border-transparent', 'hover:bg-black');
            if (key === 'saved') btn.classList.add('border-pink-200', 'text-pink-600', 'hover:bg-pink-50');
            
            btn.innerText = info.label;
            btn.dataset.cat = key;
            btn.onclick = () => setCategory(key);
            menuContainer.appendChild(btn);
        });

        // Popula o select do admin
        const catSelect = document.getElementById('addCategory');
        Object.keys(categories).forEach(k => {
            const opt = document.createElement('option');
            opt.value = k;
            opt.innerText = categories[k].label;
            catSelect.appendChild(opt);
        });

        // --- GERA√á√ÉO DE DADOS (1000 Receitas) ---
        function getImageUrl(name, id) {
            const clean = name.replace(/ /g, '%20');
            return `https://image.pollinations.ai/prompt/professional%20food%20photography%20of%20${clean}%20on%20plate%20pexels%20style%20culinary%20magazine%20high%20detail?width=600&height=400&nologo=true&seed=${id}&model=flux`;
        }

        const ingredientsPool = {
            suco: ["Laranja", "Abacaxi", "Hortel√£", "Gengibre", "Couve", "Lim√£o", "A√ß√∫car", "Gelo", "√Ågua de Coco", "Morango"],
            sopa: ["Batata", "Cenoura", "Mandioquinha", "Cebola", "Alho", "Caldo de Carne", "Macarr√£o", "Frango Desfiado", "Azeite"],
            bolo: ["Farinha de Trigo", "Ovos", "A√ß√∫car", "Leite", "Manteiga", "Fermento", "Chocolate em P√≥", "Cenoura", "Fub√°"],
            natal: ["Peru", "Chester", "Farofa", "Uvas Passas", "Nozes", "Bacalhau", "Arroz √† Grega", "Salpic√£o", "Rabanada"],
            carne: ["Picanha", "Alcatra", "Maminha", "Sal Grosso", "Alho", "Manteiga", "Alecrim", "Pimenta do Reino"],
            ave: ["Frango Inteiro", "Peito de Frango", "Coxa e Sobrecoxa", "Lim√£o", "Curry", "Batatas", "Maionese"],
            peixe: ["Til√°pia", "Salm√£o", "Camar√£o", "Leite de Coco", "Dend√™", "Coentro", "Piment√£o", "Tomate"],
            massa: ["Macarr√£o Espaguete", "Penne", "Molho de Tomate", "Queijo Parmes√£o", "Manjeric√£o", "Carne Mo√≠da", "Creme de Leite"],
            salada: ["Alface", "R√∫cula", "Tomate Cereja", "Pepino", "Manga", "Queijo Branco", "Azeite", "Mostarda e Mel"]
        };

        const nameModifiers = {
            adjectives: ['Supremo', 'Divino', 'Cremoso', 'da Vov√≥', 'R√∫stico', 'Imperial', 'Tradicional', 'Festivo', 'Suculento', 'Crocante', 'Especial', 'Caseiro', 'Fresco'],
            origins: ['Mineiro', 'Baiano', 'Carioca', 'Italiano', 'Chin√™s', 'Tailand√™s', 'do Campo', 'da Fazenda', 'do Mar', 'Serrano', 'Nordestino'],
            styles: ['ao Forno', 'Grelhado', 'Frito', 'Assado', 'Refogado', 'ao Molho', 'na Brasa', 'Vaporizado', 'Gratinado']
        };

        function generateUniqueName(category, type) {
            const patterns = [
                () => `${type} ${getRandom(nameModifiers.adjectives)}`,
                () => `${type} ${getRandom(nameModifiers.origins)}`,
                () => `${type} ${getRandom(nameModifiers.styles)}`,
                () => `${getRandom(nameModifiers.adjectives)} ${type}`
            ];
            const pattern = patterns[Math.floor(Math.random() * patterns.length)];
            return pattern();
        }

        function getRandom(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

        function generateRecipe(id, category, type) {
            const catKey = (category === 'brasileira' || category === 'chinesa') ? 'carne' : (ingredientsPool[category] ? category : 'sopa');
            const ingSource = ingredientsPool[catKey] || ingredientsPool['carne'];
            
            const ingredients = [];
            for(let i=0; i<5; i++) ingredients.push(ingSource[Math.floor(Math.random() * ingSource.length)]);

            const rating = (Math.random() * (5.0 - 4.2) + 4.2).toFixed(1);
            const name = generateUniqueName(category, type);

            return {
                id: id,
                name: name,
                originalName: `Receita Exclusiva`,
                category: category,
                energy: Math.random() > 0.5 ? 'Yang' : 'Yin',
                image: getImageUrl(name, id),
                iconFallback: categories[category]?.icon || 'https://cdn.lordicon.com/qhgmphtg.json',
                desc: `Uma deliciosa e aut√™ntica receita de ${category} para sua mesa. Sabor inigual√°vel e preparo especial.`,
                func: categories[category]?.flavor || 'Sabor',
                time: `${Math.floor(Math.random() * 40) + 20} min`,
                ingredients: ingredients,
                steps: ["Separe os ingredientes.", "Prepare a base do prato.", "Cozinhe em fogo m√©dio por 20 minutos.", "Tempere a gosto.", "Sirva imediatamente."],
                rating: rating
            };
        }

        let genId = 1000;
        function populate() {
            const baseTypes = {
                suco: ['Suco', 'Vitamina', 'Smoothie', 'Refresco', 'Drink'],
                sopa: ['Sopa', 'Caldo', 'Creme', 'Consom√™'],
                bolo: ['Bolo', 'Torta', 'Rocambole'], carne: ['Bife', 'Assado', 'Picadinho'],
                brasileira: ['Feijoada', 'Vatap√°', 'Moqueca'], chinesa: ['Yakisoba', 'Pato', 'Rolinho']
            };
            
            const cats = Object.keys(categories);
            const perCat = Math.ceil(1000 / cats.length);
            
            cats.forEach(cat => {
                const types = baseTypes[cat] || ['Prato', 'Del√≠cia', 'Especialidade'];
                for(let i=0; i<perCat; i++) {
                    const type = types[Math.floor(Math.random() * types.length)];
                    window.generatedRecipes.push(generateRecipe(genId++, cat, type));
                }
            });
            window.mergeAndRender();
        }

        window.mergeAndRender = () => {
            const fbIds = new Set(window.firebaseRecipes.map(r => r.id));
            const uniqueGen = window.generatedRecipes.filter(r => !fbIds.has(r.id));
            window.finalRecipeList = [...window.firebaseRecipes, ...uniqueGen];
            window.filterRecipes();
        }

        // --- RENDERIZA√á√ÉO ---
        window.currentCategory = 'all';
        let filtered = [];
        let page = 1;
        const perPage = 24;

        window.filterRecipes = () => {
            page = 1;
            const term = document.getElementById('searchInput').value.toLowerCase();
            const grid = document.getElementById('recipeGrid');
            grid.innerHTML = '';
            
            if(window.currentCategory === 'saved') {
                filtered = window.finalRecipeList.filter(r => window.savedRecipesSet.has(r.id) || window.savedRecipesSet.has(String(r.id)));
            } else if(window.currentCategory === 'all') {
                filtered = window.finalRecipeList;
            } else {
                filtered = window.finalRecipeList.filter(r => r.category === window.currentCategory);
            }
            
            if(term) filtered = filtered.filter(r => r.name.toLowerCase().includes(term));

            document.getElementById('totalCount').innerText = `${filtered.length} receitas`;
            
            if(filtered.length === 0) {
                document.getElementById('emptyState').classList.remove('hidden');
                document.getElementById('loadMoreContainer').classList.add('hidden');
            } else {
                document.getElementById('emptyState').classList.add('hidden');
                document.getElementById('loadMoreContainer').classList.remove('hidden');
                window.renderBatch();
            }
        };

        window.renderBatch = () => {
            const start = (page - 1) * perPage;
            const batch = filtered.slice(start, start + perPage);
            const grid = document.getElementById('recipeGrid');

            batch.forEach((r, i) => {
                const el = document.createElement('div');
                el.className = "bg-white rounded-xl shadow-sm border border-stone-100 overflow-hidden card-hover cursor-pointer group relative animate-fade-in";
                el.style.animationDelay = `${i*0.02}s`;
                el.onclick = () => window.openRecipe(r.id);

                const isFav = window.savedRecipesSet.has(r.id) || window.savedRecipesSet.has(String(r.id));
                const catInfo = categories[r.category] || { icon: 'https://cdn.lordicon.com/qhgmphtg.json' }; 

                el.innerHTML = `
                    <div class="h-48 relative bg-stone-100 flex items-center justify-center overflow-hidden">
                        <img src="${r.image}" class="w-full h-full object-cover transition duration-700 group-hover:scale-110 img-loading" 
                             onerror="this.style.display='none'; this.nextElementSibling.classList.remove('hidden')">
                        
                        <!-- Fallback Animado Lordicon -->
                        <div class="hidden absolute inset-0 flex items-center justify-center bg-stone-50">
                            <lord-icon src="${catInfo.icon}" trigger="loop" delay="2000" colors="primary:#8B0000,secondary:#DAA520" style="width:80px;height:80px"></lord-icon>
                        </div>

                        <div class="absolute inset-0 bg-gradient-to-t from-stone-900/60 via-transparent to-transparent opacity-60"></div>
                        <div class="absolute top-2 right-2 bg-white/90 px-1.5 rounded text-[10px] font-bold shadow flex items-center">
                            <i class="fas fa-star text-imperial-gold mr-1"></i> ${r.rating}
                        </div>
                        
                        <button onclick="window.toggleSaveRecipe('${r.id}', event)" class="absolute bottom-2 right-2 w-8 h-8 rounded-full hover:bg-white/20 flex items-center justify-center transition z-10">
                            <i class="${isFav ? 'fas text-imperial-red' : 'far text-white'} fa-heart text-lg heart-icon transition transform hover:scale-110"></i>
                        </button>
                    </div>
                    <div class="p-4 bg-white">
                        <div class="flex justify-between items-center mb-2">
                             <p class="text-[10px] text-imperial-red font-bold uppercase tracking-wider">${r.category}</p>
                             <div class="text-[10px] text-stone-400 flex items-center"><i class="far fa-clock mr-1"></i>${r.time}</div>
                        </div>
                        <h3 class="font-bold text-stone-800 text-sm leading-tight mb-2 font-serif group-hover:text-imperial-red transition line-clamp-2">${r.name}</h3>
                        <div class="flex items-center text-xs text-stone-500 pt-2 border-t border-stone-50">
                             <span class="flex items-center"><i class="fas fa-tag mr-1 text-orange-400"></i> ${r.func || 'Sabor'}</span>
                             <span class="ml-auto flex items-center"><i class="fas fa-shopping-basket mr-1 text-green-500"></i> ${r.ingredients ? r.ingredients.length : 0}</span>
                        </div>
                    </div>
                `;
                grid.appendChild(el);
            });

            if(start + perPage >= filtered.length) document.getElementById('loadMoreContainer').classList.add('hidden');
        };

        window.loadMore = () => { page++; window.renderBatch(); };
        window.setCategory = (c) => { 
            window.currentCategory = c; 
            document.querySelectorAll('.cat-btn').forEach(b => {
                b.classList.remove('active-cat', 'bg-stone-800', 'text-white', 'border-transparent');
                b.classList.add('bg-white', 'text-stone-600', 'border-stone-200');
                if(b.dataset.cat === c) {
                    b.classList.remove('bg-white', 'text-stone-600', 'border-stone-200');
                    b.classList.add('active-cat', 'bg-stone-800', 'text-white', 'border-transparent');
                }
            });
            window.filterRecipes(); 
        };

        // --- PAINEL ADMIN ---
        window.toggleAdminPanel = () => {
            const modal = document.getElementById('adminModal');
            modal.classList.toggle('hidden');
        };

        window.switchAdminTab = (tab) => {
            document.querySelectorAll('.admin-content').forEach(e => e.classList.add('hidden'));
            document.getElementById(`tab-${tab}`).classList.remove('hidden');
            document.querySelectorAll('.admin-tab').forEach(e => e.classList.remove('active'));
            document.getElementById(`btn-tab-${tab}`).classList.add('active');
        };

        window.saveRecipe = async () => {
            const name = document.getElementById('addName').value;
            const cat = document.getElementById('addCategory').value;
            const newRecipe = {
                id: Date.now(),
                name: name,
                category: cat,
                image: document.getElementById('addImage').value || window.getImageUrl(name, Date.now()),
                desc: document.getElementById('addDesc').value,
                ingredients: document.getElementById('addIng').value.split('\n'),
                steps: document.getElementById('addSteps').value.split('\n'),
                rating: "5.0", time: "45 min",
                func: categories[cat]?.flavor || "Especial"
            };
            
            window.firebaseRecipes.unshift(newRecipe);
            window.mergeAndRender();
            window.saveRecipeToFirebase(newRecipe);
            alert("Receita Adicionada!");
            window.toggleAdminPanel();
        };

        window.parseMagicText = () => {
            const text = document.getElementById('magicPaste').value;
            const lines = text.split('\n').filter(l => l.trim());
            if(lines.length > 0) document.getElementById('addName').value = lines[0];
            const ings = lines.filter(l => l.includes('-') || l.match(/^\d/)).join('\n');
            document.getElementById('addIng').value = ings;
        };

        window.importBulk = async () => {
            try {
                const data = JSON.parse(document.getElementById('bulkJson').value);
                if(!Array.isArray(data)) throw new Error("Deve ser um array");
                const batch = [];
                data.forEach(r => {
                    const rNew = {...r, id: Date.now() + Math.random(), func: categories[r.category]?.flavor || "Sabor"};
                    window.firebaseRecipes.push(rNew);
                    batch.push(rNew);
                });
                window.mergeAndRender();
                if(window.syncBatch) window.syncBatch(batch);
                alert(`${data.length} importados!`);
            } catch(e) { alert("Erro JSON: " + e.message); }
        };

        window.syncGeneratedToFirebase = async () => {
            if(!confirm("Enviar 1000 receitas para a nuvem?")) return;
            const batch = window.generatedRecipes.slice(0, 400); 
            await window.syncBatch(batch);
            alert("Sincroniza√ß√£o iniciada!");
        };
        
        window.downloadBackup = () => {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(window.finalRecipeList));
            const a = document.createElement('a');
            a.setAttribute("href", dataStr);
            a.setAttribute("download", "backup_receitas.json");
            document.body.appendChild(a);
            a.click();
            a.remove();
        };
        
        window.restoreBackup = (input) => {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = JSON.parse(e.target.result);
                window.firebaseRecipes = data;
                window.mergeAndRender();
                localStorage.setItem('backupData', JSON.stringify(data));
                alert("Backup Restaurado!");
            };
            reader.readAsText(file);
        };

        // --- GLOBAL START ---
        window.populate = populate;
        window.populate();
        document.getElementById('searchInput').addEventListener('input', window.filterRecipes);
        document.getElementById('recipeModal').addEventListener('click', (e) => { if(e.target.id === 'recipeModal') window.closeModal(); });

        // --- MODAL ---
        window.openRecipe = (id) => {
            const r = window.finalRecipeList.find(x => x.id == id);
            if(!r) return;
            window.currentModalRecipeId = id;
            document.getElementById('modalTitle').innerText = r.name;
            
            const img = document.getElementById('modalImage');
            img.src = r.image;
            img.style.display = 'block';
            document.getElementById('modalFallback').classList.add('hidden');
            
            // Set Fallback
            const catInfo = categories[r.category] || { icon: 'https://cdn.lordicon.com/qhgmphtg.json' };
            document.getElementById('modalLordIcon').setAttribute('src', catInfo.icon);

            const ingList = document.getElementById('modalIngredients');
            ingList.innerHTML = (r.ingredients || []).map(i => `<li class="border-b border-stone-100 py-3 flex items-start"><i class="fas fa-check text-green-600 mt-1 mr-3 text-xs"></i><span>${i}</span></li>`).join('');
            
            const stepList = document.getElementById('modalSteps');
            stepList.innerHTML = (r.steps || []).map((s, i) => `
                <div class="mb-6 flex">
                    <div class="flex-shrink-0 w-8 h-8 bg-imperial-red text-white rounded-full flex items-center justify-center font-bold mr-4 text-sm font-serif shadow-sm">${i+1}</div>
                    <p class="pt-1 text-stone-700 leading-relaxed font-light">${s}</p>
                </div>
            `).join('');
            
            document.getElementById('modalTime').innerText = r.time || "30 min";
            document.getElementById('modalFunction').innerText = r.func || "Saboroso";

            window.updateModalHeart(id);
            document.getElementById('recipeModal').classList.remove('hidden');
        };

        window.closeModal = () => {
            document.getElementById('recipeModal').classList.add('hidden');
            const v = document.getElementById('modalVideo');
            if(v) v.pause();
        };
        
        window.toggleSaveRecipe = (id, e) => {
            if(e) e.stopPropagation();
            const sid = String(id);
            if(window.savedRecipesSet.has(sid)) window.savedRecipesSet.delete(sid);
            else window.savedRecipesSet.add(sid);
            window.updateSavedUI();
            window.toggleSaveRecipeDB(sid, window.savedRecipesSet.has(sid));
        };

        window.showSavedRecipes = () => window.setCategory('saved');
        window.resetApp = () => { window.setCategory('all'); document.getElementById('searchInput').value = ''; };

        // --- TTS & ZOOM ---
        let currentUtterance = null;
        window.toggleTTS = () => {
            if (currentUtterance) { window.speechSynthesis.cancel(); currentUtterance = null; return; }
            const text = `${document.getElementById('modalTitle').innerText}. ${document.getElementById('modalDesc').innerText}`;
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'pt-BR';
            window.speechSynthesis.speak(u);
            currentUtterance = u;
        };

        window.toggleZoom = () => {
            const z = document.getElementById('zoomModal');
            const i = document.getElementById('modalImage');
            const zi = document.getElementById('zoomedImage');
            if (z.classList.contains('hidden')) { zi.src = i.src; z.classList.remove('hidden'); }
            else z.classList.add('hidden');
        };

        // --- SHARE ---
        window.shareRecipeFromModal = () => {
            const url = window.location.href + '?recipe=' + window.currentModalRecipeId;
            if(navigator.share) navigator.share({url});
            else navigator.clipboard.writeText(url).then(() => alert('Link copiado!'));
        };

        // Placeholder
        window.handleLogin = () => console.log("Auth Loading...");
        window.toggleSaveRecipeDB = () => {};
    </script>

    <!-- Firebase Module -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signInWithCustomToken, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, deleteDoc, collection, onSnapshot, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBqSUJP7BOIZSCJai83L2h-PnoyXh0oon4",
            authDomain: "culinariaimperial.firebaseapp.com",
            projectId: "culinariaimperial",
            storageBucket: "culinariaimperial.firebasestorage.app",
            messagingSenderId: "103351782200",
            appId: "1:103351782200:web:28bd29557dce703abb0fcd",
            measurementId: "G-2WJEY05TJB"
        };

        let app, auth, db, user;

        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            const analytics = getAnalytics(app);

            const initAuth = async () => {
                try {
                    if(typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
                    else if(!auth.currentUser) await signInAnonymously(auth);
                } catch(e) { window.enableOfflineMode(); }
            };
            initAuth();

            onAuthStateChanged(auth, (u) => {
                user = u;
                window.updateAuthUI(u);
                if(u) window.subscribeData();
            });

        } catch(e) { window.enableOfflineMode(); }

        // Exports
        window.handleLogin = async () => {
            try { await signInWithPopup(auth, new GoogleAuthProvider()); } 
            catch(e) { if(e.code.includes('unauthorized')) alert("Dom√≠nio n√£o autorizado."); }
        };

        window.handleLogout = async () => { try { await signOut(auth); } catch(e){} window.location.reload(); };

        window.enableOfflineMode = () => {
            const local = localStorage.getItem('backupData');
            if(local) window.firebaseRecipes = JSON.parse(local);
            window.mergeAndRender();
        };

        window.updateAuthUI = (u) => {
            document.getElementById('loginLoading').classList.add('hidden');
            if(u && !u.isAnonymous) {
                document.getElementById('loginBtn').classList.add('hidden');
                document.getElementById('userProfile').classList.remove('hidden');
                document.getElementById('userPhoto').src = u.photoURL;
                document.getElementById('userName').innerText = u.displayName;
            } else {
                document.getElementById('loginBtn').classList.remove('hidden');
                document.getElementById('userProfile').classList.add('hidden');
            }
        };

        window.subscribeData = () => {
            const col = collection(db, 'recipes');
            onSnapshot(col, (snap) => {
                window.firebaseRecipes = [];
                snap.forEach(d => window.firebaseRecipes.push({id: d.id, ...d.data()}));
                window.mergeAndRender();
            });

            if(user && !user.isAnonymous) {
                const favCol = collection(db, 'users', user.uid, 'favorites');
                onSnapshot(favCol, (snap) => {
                    window.savedRecipesSet.clear();
                    snap.forEach(d => window.savedRecipesSet.add(d.id));
                    window.updateSavedUI();
                });
            }
        };

        window.saveRecipeToFirebase = async (r) => {
            const ref = doc(db, 'recipes', r.id.toString());
            await setDoc(ref, r);
        };

        window.syncBatch = async (recipes) => {
            const batch = writeBatch(db);
            recipes.forEach(r => {
                const ref = doc(db, 'recipes', r.id.toString());
                batch.set(ref, r);
            });
            await batch.commit();
        };

        window.toggleSaveRecipeDB = async (id, isSaved) => {
            if(!user || user.isAnonymous) return;
            const ref = doc(db, 'users', user.uid, 'favorites', id.toString());
            if(isSaved) await setDoc(ref, { savedAt: new Date() });
            else await deleteDoc(ref);
        };

        window.updateSavedUI = () => {
            document.getElementById('savedCountDropdown').innerText = window.savedRecipesSet.size;
            window.filterRecipes();
            if(window.currentModalRecipeId) window.updateModalHeart(window.currentModalRecipeId);
        };

        window.updateModalHeart = (id) => {
             const btn = document.getElementById('modalSaveBtn');
             if(!btn) return;
             const icon = btn.querySelector('i');
             const isFav = window.savedRecipesSet.has(String(id)) || window.savedRecipesSet.has(id);
             icon.className = isFav ? 'fas fa-heart text-xl text-imperial-red' : 'far fa-heart text-xl';
             btn.className = `flex items-center space-x-2 px-5 py-2 rounded-full transition font-bold ${isFav ? 'bg-pink-50 text-imperial-red' : 'bg-stone-100 text-stone-600'}`;
        };
    </script>
</body>
</html>
